version: 0.2

env:
  variables:
    DBNAME: "appdb"
    PGUSER: "master"
    USER_PASS_KEY: "/psql/ecs_app_pass"
  parameter-store:
    PGHOST: "/psql/url"
    PGPASSWORD: "postgres_master_password"

phases:
  install:
    commands:
      - yum update -y
      - yum install postgresql-client pwgen -y
  build:
    commands:
      - export USER_PASS=$(pwgen -s 32 1)
      - export QUERY="CREATE USER ecs_app WITH NOSUPERUSER NOCREATEDB NOCREATEROLE PASSWORD '${USER_PASS}'"
      - psql -c "DROP ROLE IF EXISTS ecs_app" $DBNAME
      - psql -c "${QUERY}" $DBNAME
      - psql -c "SELECT rolname FROM pg_roles" $DBNAME
      - aws ssm put-parameter --name $USER_PASS_KEY --value $USER_PASS --type "SecureString" --overwrite